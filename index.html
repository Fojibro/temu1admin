<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temu Store Admin - Debug Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #fb7701;
            --primary-hover: #e06a00;
            --secondary: #333;
            --accent: #27ae60;
            --danger: #e74c3c;
            --light: #fff;
            --dark: #222;
            --bg: #f5f5f5;
            --font-family: 'Inter', sans-serif;
            --radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--secondary);
            line-height: 1.6;
        }

        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .dashboard-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .hidden {
            display: none !important;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .header-logo {
            color: var(--primary);
            font-weight: 800;
            font-size: 1.5rem;
            text-decoration: none;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
            font-family: inherit;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: opacity 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-success {
            background-color: var(--accent);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid #ddd;
            color: #666;
            padding: 10px 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .product-list {
            display: grid;
            gap: 15px;
        }

        .product-item {
            display: flex;
            align-items: center;
            background: #fff;
            padding: 15px;
            border-radius: var(--radius);
            border: 1px solid #eee;
            gap: 20px;
        }

        .product-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            background: #eee;
        }

        .product-details {
            flex-grow: 1;
        }

        .error-message {
            color: var(--danger);
            background: rgba(231, 76, 60, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: none;
        }

        #status-msg {
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            font-weight: bold;
            display: none;
        }
    </style>
</head>

<body>

    <!-- Login Section -->
    <div id="login-section" class="auth-container">
        <h2 style="color: var(--primary);">Your business admin control</h2>
        <p>Sign in to manage products</p>
        <p class="error-message" id="login-error"></p>
        <form id="login-form">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="email" class="form-control" placeholder="admin@example.com" required>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="password" class="form-control" placeholder="â¢â¢â¢â¢â¢â¢" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
        </form>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="dashboard-container hidden">
        <div class="header-row">
            <a href="#" class="header-logo">Your business admin control page</a>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="user-email" style="font-size: 0.9rem; color: #777;"></span>
                <button id="logout-btn" class="btn btn-outline">Logout</button>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0">Add / Edit Product</h3>
            <form id="product-form">
                <input type="hidden" id="edit-id">

                <div class="form-group">
                    <label class="form-label">Product Title</label>
                    <input type="text" id="p-title" class="form-control" placeholder="Title" required>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Price</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="p-currency" class="form-control" value="PKR" style="width: 80px;">
                            <input type="number" id="p-price" class="form-control" placeholder="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <input type="text" id="p-category" class="form-control" list="category-list"
                            placeholder="Select or type..." required>
                        <datalist id="category-list"></datalist>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Product Image</label>
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px dashed #ccc;">
                        <input type="file" id="p-image-file" class="form-control" accept="image/*">
                        <p style="text-align: center; margin: 10px 0;">- OR -</p>
                        <input type="url" id="p-image" class="form-control" placeholder="Paste image URL here">
                    </div>
                    <div id="upload-progress"
                        style="display:none; color:var(--primary); font-size: 0.8rem; margin-top:5px;"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="p-desc" class="form-control" rows="3"></textarea>
                </div>

                <button type="submit" class="btn btn-primary" id="save-btn">Save Product</button>
                <button type="button" class="btn btn-outline" id="clear-btn">Cancel</button>

                <div id="status-msg"></div>
            </form>
        </div>

        <h3>Inventory</h3>
        <div id="admin-product-list" class="product-list">
            <p style="text-align:center; padding: 20px;">Loading...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, orderBy, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDoiawZyC2HiHF1uEjZRIFf-xMlmYz9fSU",
            authDomain: "your-site-39a39.firebaseapp.com",
            projectId: "your-site-39a39",
            storageBucket: "your-site-39a39.firebasestorage.app",
            messagingSenderId: "80434141233",
            appId: "1:80434141233:web:56e96b032994b0823c5d10",
            measurementId: "G-YN495C472N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let storage = null;
        try { storage = getStorage(app); } catch (e) { console.warn("Storage missing"); }

        const statusMsg = document.getElementById('status-msg');
        const saveBtn = document.getElementById('save-btn');
        const productForm = document.getElementById('product-form');

        function showStatus(msg, type = 'info') {
            statusMsg.textContent = msg;
            statusMsg.style.display = 'block';
            statusMsg.style.backgroundColor = type === 'error' ? '#fdecea' : (type === 'success' ? '#edf7ed' : '#e5f6fd');
            statusMsg.style.color = type === 'error' ? '#d32f2f' : (type === 'success' ? '#2e7d32' : '#0288d1');
            console.log(`[Status] ${msg}`);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
                loadProducts();
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('dashboard-section').classList.add('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const err = document.getElementById('login-error');
            err.style.display = 'none';
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
            } catch (e) {
                err.textContent = e.message;
                err.style.display = 'block';
            }
        });

        document.getElementById('logout-btn').onclick = () => signOut(auth);

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            saveBtn.disabled = true;
            saveBtn.textContent = 'Processing...';
            showStatus("Starting save process...");

            try {
                let imageUrl = document.getElementById('p-image').value;
                const fileInput = document.getElementById('p-image-file');

                if (fileInput.files.length > 0) {
                    if (!storage) throw new Error("Firebase Storage is not enabled in your console.");
                    showStatus("Uploading image to Firebase Storage...");
                    const file = fileInput.files[0];
                    const sRef = ref(storage, 'products/' + Date.now() + '_' + file.name);
                    const snap = await uploadBytesResumable(sRef, file);
                    imageUrl = await getDownloadURL(snap.ref);
                }

                const data = {
                    title: document.getElementById('p-title').value,
                    price: Number(document.getElementById('p-price').value),
                    currency: document.getElementById('p-currency').value || 'PKR',
                    category: document.getElementById('p-category').value,
                    imageUrl: imageUrl,
                    description: document.getElementById('p-desc').value,
                    updatedAt: new Date()
                };

                const id = document.getElementById('edit-id').value;
                showStatus("Saving data to Firestore Database...");

                // Manual Timeout for Firestore (15 seconds)
                const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Database Timeout: Check your Firestore rules or Internet.")), 15000));

                const saveOp = id ?
                    updateDoc(doc(db, "products", id), data) :
                    addDoc(collection(db, "products"), { ...data, createdAt: new Date() });

                await Promise.race([saveOp, timeout]);

                showStatus("Success! Product saved.", "success");
                productForm.reset();
                document.getElementById('edit-id').value = '';
                saveBtn.textContent = 'Save Product';
                setTimeout(() => { statusMsg.style.display = 'none'; }, 4000);

            } catch (err) {
                console.error(err);
                showStatus("FAILED: " + err.message, "error");
            } finally {
                saveBtn.disabled = false;
                if (saveBtn.textContent === 'Processing...') saveBtn.textContent = 'Save Product';
            }
        });

        function loadProducts() {
            const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('admin-product-list');
                list.innerHTML = '';
                const cats = new Set();

                if (snap.empty) {
                    list.innerHTML = '<p style="text-align:center">Empty Inventory.</p>';
                    return;
                }

                snap.forEach(d => {
                    const p = d.data();
                    cats.add(p.category);
                    const div = document.createElement('div');
                    div.className = 'product-item';
                    div.innerHTML = `
                        <img src="${p.imageUrl}" class="product-thumb">
                        <div class="product-details">
                            <h4>${p.title}</h4>
                            <p>${p.currency} ${p.price}</p>
                        </div>
                        <button class="btn btn-danger" onclick="deleteProduct('${d.id}')">Delete</button>
                    `;
                    list.appendChild(div);
                });

                // Update Datalist
                const dl = document.getElementById('category-list');
                dl.innerHTML = '';
                cats.forEach(c => {
                    const o = document.createElement('option');
                    o.value = c;
                    dl.appendChild(o);
                });
            }, (err) => {
                showStatus("Sync Error: " + err.message, "error");
            });
        }

        window.deleteProduct = async (id) => {
            if (confirm("Delete?")) await deleteDoc(doc(db, "products", id));
        };

        document.getElementById('clear-btn').onclick = () => {
            productForm.reset();
            document.getElementById('edit-id').value = '';
            saveBtn.textContent = 'Save Product';
        };
    </script>
</body>

</html>

